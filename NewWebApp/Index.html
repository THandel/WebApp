<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Index page</title>

    <script src="Scripts/jquery-2.2.1.min.js"></script>
    <script src="Scripts/highcharts/4.2.0/highcharts.js"></script>
    <script src="Scripts/highcharts/4.2.0/highcharts-more.js"></script>

    <style>
        /* Simple border so you can see the boundaries of the chart*/
        #chartContainer {
            border: 1px solid black;
        }
    </style>

    <script language="JavaScript">
        $(document).ready(function () {

            //removed existing chart

            $.getJSON('http://localhost:2603/odata/LinqDatas', function (dataIncoming) {

                console.group("Data Incoming");
                console.debug(dataIncoming);
                console.groupEnd();

                secondChart(dataIncoming);

                var data = {
                    csv: dataIncoming.value
                };
                json.data = data;
                $('#chartContainer').highcharts(json);
            }).fail(function (jqxhr, textStatus, error) {
                var err = textStatus + ", " + error;
                console.log("Request Failed: " + err);
            });
        });


        function secondChart(data) {
            console.group("Data for chart");
            console.debug(data.value);
            console.groupEnd();

           // var preparedData = [];
            var euroData = []; //array to hold data in euro 
            var gbpData = []; //array to hold data in pounds
            var msqData = []; //new empty array to hold second series 

            for (var i = 0, len = data.value.length; i < len; i++) {

                /* data.value[i] looks like this :
              
                aggregateMSQ: ""3715.1800"
                curr:"E"
                deliveryDate:"25/03/2016          "
                deliveryTime:"01:00     "
                smp:"31.73"
                tradeDate:"24/03/2016          "

                */
                //prepare date:
                // get date from deliveryDate in format yyyy-mm-dd
                if (data.value[i].deliveryDate == "26/03/2016          ") {
                    //very crude date filtering to check that values are returned correctly

                    var dateArray = data.value[i].deliveryDate.substring(0, 10).split('/'); // returns string from index 0 and 10 characters : 25/03/2016 and split where is '/'
                    var currVal = data.value[i].curr.substring(0, 1); //get the currency flag - returns from Linq as "E" 
                    var timeArray = data.value[i].deliveryTime.substring(0, 5).split(':'); //split time into hours and mins
                    var date = Date.UTC( parseInt(dateArray[2]), parseInt(dateArray[1] - 1), parseInt(dateArray[0]), parseInt(timeArray[0]), parseInt(timeArray[1]), 0, 0);
                    console.log(date);
                    var newDate = new Date(date); //get date as type Date
                    var dateTitle = newDate.toLocaleDateString("en-GB"); //format to dd/mm/yyyy to use in title of chart

                    var msq = data.value[i].aggregateMSQ; //new variable for MSQ data

                    var item = [date, parseFloat(data.value[i].smp)];  // create item consisting from Date and SMP. if you check the data sample above, you can see that the smp is "string". it must be casted to float for the chart

                    if (currVal == "E") { //if currency flag is E
                        euroData.push(item); //push the data item to the euro series
                    }

                    else if (currVal == "P") { //if currency flag is P
                        gbpData.push(item); //push data item to the £ series
                    }

                    var msqItems = [date, parseFloat(msq)]; //create new item containing MSQ vs date
                    msqData.push(msqItems); //add MSQ data items to array
                }
            }

            console.log(msqData);

            $('#chartContainer').highcharts({

                chart: {
                    zoomType: 'x',
                    alignTicks : false
                },
                title: {
                    text: 'Market Data over time for ' + dateTitle //date included in title
                },
                subtitle: {
                    text: document.ontouchstart === undefined ?
                            'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
                },
                xAxis: {
                    type: 'datetime',
                    tickInterval: 1800000 //ticks every 30mins
                },
                yAxis: [{ //primary y-axis for euro data
                    title: {
                        text: ''
                    },
                },{ //second y-axis for SMP £ data
                    title: {
                        text: ''
                    },
                },{
                    title: { //third y-axis for MSQ data
                        text: 'Aggregate MSQ',
                    },
                    labels: {
                        format: '{value} MWh',  //not sure of units for MSQ - will check
                        opposite: true
                    },
                    opposite: true, //third y-axis should be opposite primary y-axis
                }],
                tooltip: {
                    shared: true //shared tooltip so that user can read all three values for a data point at the same time
                },
                legend: {
                    enabled: true //enable legend to allow user to switch between the three data series
                },
                plotOptions: {
                    area: {
                        fillColor: {
                            linearGradient: {
                                x1: 0,
                                y1: 0,
                                x2: 0,
                                y2: 1
                            },
                            stops: [
                                [0, '#1190FF'],
                                [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                            ]
                        },
                        marker: {
                            radius: 2
                        },
                        lineWidth: 1,
                        states: {
                            hover: {
                                lineWidth: 1
                            }
                        },
                        threshold: null
                    }
                },

                series: [{
                    type: 'area', //first series - SMP in euro
                    name: 'SMP - Euro',
                    color: '#20647F',
                    data: euroData // use euro data
                },{
                    type: 'area', //second series - SMP in £
                    name: 'SMP - Pounds',
                    color: '#00BDCC',
                    data: gbpData // use pounds data
                }, {
                    type: 'area', //third series - MSQ
                    name: 'Aggregate MSQ',
                    color: '#4B467F',
                    yAxis : 1,
                    data: msqData //third series uses MSQData
                }]
            });
        }
    </script>
</head>
<body>
    <div id="chartContainer" style="width:100%; height:400px;"></div><hr />
    <input id="Submit1" type="submit" value="submit" />
    <input id="dateSelect" type="date" />
    <input id="Reset1" type="reset" value="reset" /><hr />
</body>
</html>
