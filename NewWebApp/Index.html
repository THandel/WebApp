<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Index page</title>

    <script src="Scripts/jquery-2.2.2.min.js"></script>
    <script src="Scripts/highcharts/4.2.0/highcharts.js"></script>
    <script src="Scripts/highcharts/4.2.0/highcharts-more.js"></script>

    <style>
        /* Simple border so you can see the boundaries of the chart*/
        #chartContainer {
            border: 1px solid black;
        }
    </style>

    <script language="JavaScript">
        var defaultDate = '';
        $(document).ready(function () {
            defaultDate = '2016-03-26';
            console.log(defaultDate);
            var DateIn = getDateVal();
            console.log(DateIn);
            defaultDate = dateOutParse(DateIn);
            console.log(defaultDate);
            var getDate = dateInParse(DateIn);
            console.log(getDate);
            console.log(getDate); //log date to console for testing
            var queryStr = "http://localhost:2603/odata/LinqDatas('" + getDate + "')"; //concatenate the query string
            console.log(queryStr); //log query string to console for verification
            $.getJSON(queryStr, function (dataIncoming) { //pass query string to getJSON method
                console.group("Data Incoming");
                console.debug(dataIncoming);
                console.groupEnd();
                secondChart(dataIncoming);
                var data = {
                    csv: dataIncoming.value
                };
                json.data = data;
                $('#chartContainer').highcharts(json);
            }).fail(function (jqxhr, textStatus, error) {
                var err = textStatus + ", " + error;
                console.log("Request Failed: " + err);
            });
        });
        function secondChart(data) {
            console.group("Data for chart");
            console.debug(data.value);
            console.groupEnd();
            var euroData = []; //array to hold data in euro
            var gbpData = []; //array to hold data in pounds
            var msqData = []; //new empty array to hold second series
            for (var i = 0, len = data.value.length; i < len; i++) {
                    var dateArray = data.value[i].deliveryDate.substring(0, 10).split('/'); // returns string from index 0 and 10 characters : 25/03/2016 and split where is '/'
                    var currVal = data.value[i].curr.substring(0, 1); //get the currency flag - returns from Linq as "E"
                    var timeArray = data.value[i].deliveryTime.substring(0, 5).split(':'); //split time into hours and mins
                    var date = Date.UTC(parseInt(dateArray[2]), parseInt(dateArray[1] - 1), parseInt(dateArray[0]), parseInt(timeArray[0]), parseInt(timeArray[1]), 0, 0);
                    var newDate = new Date(date); //get date as type Date
                    var dateTitle = newDate.toLocaleDateString("en-GB"); //format to dd/mm/yyyy to use in title of chart
                    var msq = data.value[i].aggregateMSQ; //new variable for MSQ data
                    var item = [date, parseFloat(data.value[i].smp)];  // create item consisting from Date and SMP. if you check the data sample above, you can see that the smp is "string". it must be casted to float for the chart
                    if (currVal == "E") { //if currency flag is E
                        euroData.push(item); //push the data item to the euro series
                    }
                    else if (currVal == "P") { //if currency flag is P
                        gbpData.push(item); //push data item to the £ series
                    }
                    var msqItems = [date, parseFloat(msq)]; //create new item containing MSQ vs date
                    msqData.push(msqItems); //add MSQ data items to array
            }
            console.log(msqData);
            $('#chartContainer').highcharts({
                chart: {
                    zoomType: 'x',
                    alignTicks: false
                },
                title: {
                    text: 'Market Data over time for ' + dateTitle //date included in title
                },
                subtitle: {
                    text: document.ontouchstart === undefined ?
                            'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
                },
                xAxis: {
                    type: 'datetime',
                    tickInterval: 1800000 //ticks every 30mins
                },
                yAxis: [{ //primary y-axis for euro data
                    title: {
                        text: ''
                    },
                }, { //second y-axis for SMP £ data
                    title: {
                        text: ''
                    },
                }, {
                    title: { //third y-axis for MSQ data
                        text: 'Aggregate MSQ',
                    },
                    labels: {
                        format: '{value} MWh',  //not sure of units for MSQ - will check
                        opposite: true
                    },
                    opposite: true, //third y-axis should be opposite primary y-axis
                }],
                tooltip: {
                    shared: true //shared tooltip so that user can read all three values for a data point at the same time
                },
                legend: {
                    enabled: true //enable legend to allow user to switch between the three data series
                },
                plotOptions: {
                    area: {
                        fillColor: {
                            linearGradient: {
                                x1: 0,
                                y1: 0,
                                x2: 0,
                                y2: 1
                            },
                            stops: [
                                [0, '#1190FF'],
                                [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                            ]
                        },
                        marker: {
                            radius: 2
                        },
                        lineWidth: 1,
                        states: {
                            hover: {
                                lineWidth: 1
                            }
                        },
                        threshold: null
                    }
                },
                series: [{
                    type: 'area', //first series - SMP in euro
                    name: 'SMP - Euro',
                    color: '#20647F',
                    data: euroData // use euro data
                }, {
                    type: 'area', //second series - SMP in £
                    name: 'SMP - Pounds',
                    color: '#00BDCC',
                    data: gbpData // use pounds data
                }, {
                    type: 'area', //third series - MSQ
                    name: 'Aggregate MSQ',
                    color: '#4B467F',
                    yAxis: 1,
                    data: msqData //third series uses MSQData
                }]
            });
        }
        
        function getDateVal() {
            console.log("getDateVal function fired");
            var DateIn = document.forms["inputForm"]["dateSelect"].value;  //get value in date selector box
            console.log("input date: " + DateIn);
            document.forms["inputForm"]["dateSelect"].value = DateIn;
            console.log("date out:" + document.forms["inputForm"]["dateSelect"].value);
            return DateIn;
        }

        function dateInParse(dateInput) {
            console.log("dateInParse funtion fired");
            var s = (dateInput.toString().split('-')); //date in selector is by default in format YYYY-MM-DD
            // Need to split this into DD-MM-YYYY
            var getDate = ([s[2], s[1], s[0]].join('-')); //join the split sections of the date back together
            return getDate;
        }
        function dateOutParse(dateInput) {
            console.log("dateOutParse funtion fired");
            var s = (dateInput.toString().split('-')); //date in selector is by default in format YYYY-MM-DD
            // Need to split this into DD-MM-YYYY
            var outDate = ([s[2], s[1], s[0]].join('-')); //join the split sections of the date back together
            console.log(outDate);
            return outDate;
        }
    </script>
</head>
<body>
    <div id="chartContainer" style="width:100%; height:400px;"></div>
    
    <div id="inputDiv" onload="dateOutParse(defaultDate)" style="width:100%; height:100px;">
        <form name='inputForm' method='get'>
            <fieldset>
                <legend> Select a new date </legend>
                <hr />
                <input id="dateSelect" type="date" value=defaultDate onchange="getDateVal()"/>
                <input id="dateSubmit" type="submit" value="Submit" onchange="$('#inputForm').submit();" />
                <input id="dateReset" type="reset" value="Reset" />
                <hr />
            </fieldset>
        </form>
    </div>
        
</body>
</html>