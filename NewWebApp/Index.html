<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Index page</title>

    <script src="Scripts/jquery-2.2.2.min.js"></script>
    <script src="Scripts/highcharts/4.2.0/highcharts.js"></script>
    <script src="Scripts/highcharts/4.2.0/highcharts-more.js"></script>
    <link href="/styleSheet.css" rel="stylesheet" type="text/css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

    <style>
        
        #wrapper {
            width: 100%;
            overflow: hidden;
            height: 450px;
        }

        #chartContainer {
            width: 70%;
            float: left;
            padding:10px;
            border: 1px solid black;
            height: 400px;
        }

        #inputDiv {
            width: 20%;
            float:right;
            overflow: hidden;
        }    
    </style>

    <script language="JavaScript">
        var data;
        $(document).ready(function () {
            var DateInput = "26/03/2016";
            var chart1;
            $("#btnPrint").live("click", function () {
                var contents = $("#printContents").html();
                var printWindow = window.open('', '', 'height=400,width=800');
                printWindow.document.write('<html><head>');
                printWindow.document.write('</head><body >');
                printWindow.document.write(contents);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            });
                    $('#datepick').datepicker({
                        dateFormat: "dd/mm/yy",
                        minDate: new Date(2016, 3 - 1, 24),
                        maxDate: new Date(2016, 3 - 1, 29),
                        onSelect: function () {
                            DateInput = $("#datepick").datepicker({ dateFormat: 'dd/MM/yyyy' }).val();
                            console.log(DateInput);

                            var queryStr = "http://localhost:2603/odata/LinqDatas?$filter=(deliveryDate eq '" + DateInput + "')";
                            console.log(queryStr);
                            
                            $.getJSON(queryStr, function (dataIncoming) { //pass query string to getJSON method
                                console.group("Data Incoming");
                                console.debug(dataIncoming);
                                console.groupEnd();
                                secondChart(dataIncoming);
                                drawTbl(dataIncoming);
                                var data = {
                                    csv: dataIncoming.value
                                };
                                JSON.data = data;
       
                            }).fail(function (jqxhr, textStatus, error) {
                                var err = textStatus + ", " + error;
                                console.log("Request Failed: " + err);
                            });
                        }
                    });
        });
        function drawTbl(data) {
            var tr, td;
            var tbody = document.getElementById("rptBody"); //get table body from html
            tbody.innerHTML = ""; //clear any existing data from table
            for (var i = 0, len = data.value.length; i < len; i++) {
                //iterate through the incoming data
                tr = tbody.insertRow(tbody.rows.length);
                //insert a row
                td = tr.insertCell(tr.cells.length);
                //insert cell
                td.setAttribute("align", "center");
                //set alignment
                td.innerHTML = data.value[i].deliveryTime;
                //put data point into cell
                td = tr.insertCell(tr.cells.length);
                td.innerHTML = data.value[i].aggregateMSQ;
                td = tr.insertCell(tr.cells.length);
                td.innerHTML = data.value[i].smp;
                td = tr.insertCell(tr.cells.length);
                td.innerHTML = data.value[i].curr;
                //td = tr.insertCell(tr.cells.length);
            }
        }

         function secondChart(data) {
            console.group("Data for chart");
            console.debug(data.value);
            console.groupEnd();
            var euroData = []; //array to hold data in euro
            var gbpData = []; //array to hold data in pounds
            var msqData = []; //new empty array to hold second series
            for (var i = 0, len = data.value.length; i < len; i++) {
                var dateArray = data.value[i].deliveryDate.substring(0, 10).split('/'); // returns string from index 0 and 10 characters : 25/03/2016 and split where is '/'
                var currVal = data.value[i].curr; //get the currency flag - returns from Linq as "E"
                var timeArray = data.value[i].deliveryTime.substring(0, 5).split(':'); //split time into hours and mins
                var date = Date.UTC(parseInt(dateArray[2]), parseInt(dateArray[1] - 1), parseInt(dateArray[0]), parseInt(timeArray[0]), parseInt(timeArray[1]), 0, 0);
                var newDate = new Date(date); //get date as type Date
                var dateTitle = newDate.toLocaleDateString("en-GB"); //format to dd/mm/yyyy to use in title of chart
                var msq = data.value[i].aggregateMSQ; //new variable for MSQ data
                var item = [date, parseFloat(data.value[i].smp)];  // create item consisting from Date and SMP. if you check the data sample above, you can see that the smp is "string". it must be casted to float for the chart
                if (currVal == "E") { //if currency flag is E
                    euroData.push(item); //push the data item to the euro series
                }
                else if (currVal == "P") { //if currency flag is P
                    gbpData.push(item); //push data item to the £ series
                }
                var msqItems = [date, parseFloat(msq)]; //create new item containing MSQ vs date
                msqData.push(msqItems); //add MSQ data items to array
            }
            console.log(msqData);

            chart1 = new Highcharts.Chart({
                chart: {
                    zoomType: 'x',
                    alignTicks: false,
                    renderTo: 'chartContainer'
                },
                title: {
                    text: 'Market Data over time for ' + dateTitle //date included in title
                },
                subtitle: {
                    text: document.ontouchstart === undefined ?
                            'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
                },
                xAxis: {
                    type: 'datetime',
                    tickInterval: 1800000 //ticks every 30mins
                },
                yAxis: [{ //primary y-axis for euro data
                    title: {
                        text: ''
                    },
                }, { //second y-axis for SMP £ data
                    title: {
                        text: ''
                    },
                }, {
                    title: { //third y-axis for MSQ data
                        text: 'Aggregate MSQ',
                    },
                    labels: {
                        format: '{value} MWh',  //not sure of units for MSQ - will check
                        opposite: true
                    },
                    opposite: true, //third y-axis should be opposite primary y-axis
                }],
                tooltip: {
                    shared: true //shared tooltip so that user can read all three values for a data point at the same time
                },
                legend: {
                    enabled: true //enable legend to allow user to switch between the three data series
                },
                plotOptions: {
                    area: {
                        fillColor: {
                            linearGradient: {
                                x1: 0,
                                y1: 0,
                                x2: 0,
                                y2: 1
                            },
                            stops: [
                                [0, '#AEAEB0'],
                                [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                            ]
                        },
                        marker: {
                            radius: 2
                        },
                        lineWidth: 1,
                        states: {
                            hover: {
                                lineWidth: 1
                            }
                        },
                        threshold: null
                    }
                },
                series: [{
                    type: 'area', //first series - SMP in euro
                    name: 'SMP - Euro',
                    color: '#20647F',
                    data: euroData // use euro data
                }, {
                    type: 'area', //second series - SMP in £
                    name: 'SMP - Pounds',
                    color: '#5A5F7F',
                    data: gbpData // use pounds data
                }, {
                    type: 'area', //third series - MSQ
                    name: 'Aggregate MSQ',
                    color: '#4B467F',
                    yAxis: 1,
                    data: msqData //third series uses MSQData
                }]
            });
        };      
    </script>
    <script>
        function hideData() {
            document.getElementById("reportData").style.display = "none";
        }

        function showData() {
            document.getElementById("reportData").style.display = "block";
        }
    </script>
</head>
<body style="background: #F2F2F5; ">
    <form id="printContents" style="padding:50px;">
        <p class="h">Placeholder Header<br></p>
        <div id="wrapper" style="padding:50px;">
            <div id="chartContainer" style="background-color: #F9FAFC;"></div>

            <div class="inputDiv" style="padding:50px;">
                <div class="dropdown-content">
                    <hr />
                    <p class="small">Date: <input type="text" id="datepick" size="30" /> </p>
                    <hr />
                </div>
            </div>
            <br />
            <input type="button" value="Print Report" id="btnPrint" />
            <input type="button" value="Show Data" id="showBtn" onclick="showData()"/>
            <input type="button" value="Hide Data" id="hideBtn" onclick="hideData()"/>
        </div>
        
        <table id="reportData" cellpadding="10" cellspacing="5" style="width:75%; display:none; float:right;">
            <thead style="text-align:left;">
                <tr>
                    <th>Delivery Time</th>
                    <th>Aggregate MSQ</th>
                    <th>SMP</th>
                    <th>Currency</th>
                </tr>
            </thead>
            <tbody id="rptBody"></tbody>
        </table>
        </form>
</body>
</html>